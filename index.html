<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Manager Pro Elite - Advanced Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --primary:#6366f1;--primary-light:#818cf8;--primary-dark:#4f46e5;
            --secondary:#ec4899;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;
            --bg-dark:#0f172a;--surface-dark:#1e293b;--border-dark:#334155;
            --text-light:#f1f5f9;--text-gray:#cbd5e1
        }
        html{
            --bg:var(--bg-dark);--surface:var(--surface-dark);
            --border:var(--border-dark);--text:var(--text-light);
            --text-secondary:var(--text-gray)
        }
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:var(--bg);color:var(--text);overflow:hidden
        }
        .app{display:none;height:100vh;flex-direction:column}
        .app.active{display:flex}
        .header{
            background:var(--surface);border-bottom:1px solid var(--border);
            padding:15px 30px;display:flex;justify-content:space-between;
            align-items:center;flex-wrap:wrap;gap:15px
        }
        .header-left{display:flex;align-items:center;gap:20px}
        .logo{
            font-size:20px;font-weight:800;
            background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent
        }
        .page-title{font-size:20px;font-weight:700}
        .header-right{display:flex;align-items:center;gap:15px;flex-wrap:wrap}
        .rate-display{
            background:rgba(99,102,241,.15);border:1px solid var(--primary);
            padding:10px 15px;border-radius:8px;font-weight:600;
            display:flex;align-items:center;gap:8px
        }
        .rate-live{
            width:10px;height:10px;background:var(--success);
            border-radius:50%;animation:pulse 2s infinite
        }
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        .user-profile{display:flex;align-items:center;gap:10px}
        .avatar{
            width:32px;height:32px;border-radius:50%;
            background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);
            color:#fff;display:flex;align-items:center;justify-content:center;
            font-weight:600;font-size:12px
        }
        .logout-btn{
            padding:8px 16px;background:var(--danger);color:#fff;border:none;
            border-radius:6px;cursor:pointer;font-weight:600
        }
        .logout-btn:hover{background:#dc2626}
        .sidebar{
            width:280px;background:var(--surface);border-right:1px solid var(--border);
            display:flex;flex-direction:column;overflow-y:auto
        }
        .sidebar-menu{flex:1;padding:20px 0}
        .menu-item{
            padding:12px 20px;cursor:pointer;color:var(--text-secondary);
            border-left:3px solid transparent;font-size:14px;font-weight:500;
            transition:all .2s
        }
        .menu-item:hover{
            background:rgba(99,102,241,.1);color:var(--primary-light)
        }
        .menu-item.active{
            background:rgba(99,102,241,.15);color:var(--primary);
            border-left-color:var(--primary)
        }
        .content-wrapper{display:flex;flex:1;overflow:hidden}
        .content{flex:1;overflow-y:auto;padding:30px}
        .section{display:none}
        .section.active{display:block}
        .card{
            background:var(--surface);border:1px solid var(--border);
            border-radius:12px;padding:20px;margin-bottom:20px
        }
        .card-title{
            font-size:16px;font-weight:700;margin-bottom:15px;
            padding-bottom:12px;border-bottom:2px solid var(--border)
        }
        .upload-zone{
            border:2px dashed var(--primary);border-radius:8px;padding:20px;
            text-align:center;cursor:pointer;transition:all .2s;
            background:rgba(99,102,241,.05)
        }
        .upload-zone:hover{
            background:rgba(99,102,241,.1);border-color:var(--primary-light)
        }
        .upload-zone input{display:none}
        .btn{
            padding:10px 20px;border:none;border-radius:8px;
            font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;
            display:inline-flex;align-items:center;gap:8px
        }
        .btn-primary{
            background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
            color:#fff
        }
        .btn-primary:hover{transform:translateY(-2px)}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-danger:hover{background:#dc2626}
        .stats-grid{
            display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
            gap:15px;margin-bottom:20px
        }
        .stat-card{
            background:var(--surface);border:1px solid var(--border);
            border-radius:12px;padding:20px;text-align:center
        }
        .stat-label{font-size:12px;color:var(--text-secondary);margin-bottom:8px}
        .stat-value{
            font-size:28px;font-weight:800;
            background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent
        }
        .matrix-table{width:100%;border-collapse:collapse;font-size:13px}
        .matrix-table th,.matrix-table td{
            padding:12px;text-align:center;border:1px solid var(--border)
        }
        .matrix-table th{
            background:rgba(99,102,241,.15);font-weight:600;color:var(--primary)
        }
        .price-cell{
            padding:10px;border-radius:6px;font-weight:600;
            animation:slideIn .3s ease-out
        }
        .price-cell.best{
            background:rgba(16,185,129,.2);color:var(--success)
        }
        .price-cell.average{
            background:rgba(99,102,241,.2);color:var(--primary)
        }
        .price-cell.high{
            background:rgba(239,68,68,.15);color:var(--danger)
        }
        @keyframes slideIn{
            from{opacity:0;transform:translateY(-5px)}
            to{opacity:1;transform:translateY(0)}
        }
        .analytics-grid{
            display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
            gap:15px;margin-bottom:20px
        }
        .analysis-card{
            background:var(--surface);border:1px solid var(--border);
            border-radius:12px;padding:15px
        }
        .analysis-title{font-weight:600;margin-bottom:10px;color:var(--primary);font-size:13px}
        .analysis-value{font-size:18px;font-weight:700;margin-bottom:5px}
        .analysis-subtitle{font-size:11px;color:var(--text-secondary)}
        .login-page{
            display:none;min-height:100vh;
            background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);
            align-items:center;justify-content:center;position:fixed;
            inset:0;z-index:1000
        }
        .login-page.active{display:flex}
        .login-box{
            background:var(--surface);padding:40px;border-radius:16px;
            width:100%;max-width:420px
        }
        .login-box h1{margin:0 0 30px;text-align:center;color:var(--primary);font-size:24px}
        .form-group{margin-bottom:15px}
        .form-group label{
            display:block;font-size:12px;font-weight:600;
            margin-bottom:6px;color:var(--text-secondary)
        }
        .form-group input{
            width:100%;padding:10px 12px;background:var(--bg);
            border:1px solid var(--border);border-radius:8px;
            color:var(--text);font-size:14px
        }
        .form-group input:focus{
            outline:none;border-color:var(--primary);
            box-shadow:0 0 0 3px rgba(99,102,241,.1)
        }
        .toast{
            position:fixed;bottom:20px;right:20px;background:var(--surface);
            border-left:4px solid var(--success);padding:16px 20px;border-radius:8px;
            box-shadow:0 8px 24px rgba(0,0,0,.2);z-index:9999;
            animation:slideInRight .3s ease
        }
        .toast.error{border-left-color:var(--danger)}
        @keyframes slideInRight{
            from{transform:translateX(400px);opacity:0}
            to{transform:translateX(0);opacity:1}
        }
        table{width:100%;border-collapse:collapse;margin-top:15px}
        table th,table td{
            padding:10px;text-align:left;border-bottom:1px solid var(--border)
        }
        table th{
            background:rgba(99,102,241,.1);font-weight:600
        }
        table tr:hover{background:rgba(99,102,241,.05)}
        .badge{
            display:inline-block;padding:4px 10px;border-radius:6px;
            font-size:11px;font-weight:600
        }
        .badge-success{background:rgba(16,185,129,.2);color:var(--success)}
        .badge-warning{background:rgba(245,158,11,.2);color:var(--warning)}
        @media (max-width:768px){
            .content-wrapper{flex-direction:column}
            .sidebar{
                width:100%;height:auto;border-right:none;
                border-bottom:1px solid var(--border);flex-direction:row;overflow-x:auto
            }
            .sidebar-menu{display:flex;gap:0;padding:0}
            .menu-item{
                white-space:nowrap;flex:1;border-left:none;
                border-bottom:3px solid transparent
            }
            .menu-item.active{
                border-left:none;border-bottom-color:var(--primary)
            }
            .stats-grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
            .header{padding:12px 15px;font-size:13px}
            .content{padding:15px}
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginApp" class="login-page active">
        <div class="login-box">
            <h1>üíé Price Manager Pro</h1>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" value="admin@example.com">
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="loginPassword" value="admin123">
            </div>
            <button class="btn btn-primary" style="width:100%;margin-top:10px" onclick="handleLogin()">
                –í—Ö–æ–¥
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="app">
        <div class="header">
            <div class="header-left">
                <div class="logo">‚öôÔ∏è PMP Elite</div>
                <div class="page-title" id="pageTitle">üìä –î–∞—à–±–æ—Ä–¥</div>
            </div>
            <div class="header-right">
                <div class="rate-display">
                    <span class="rate-live"></span>
                    <span>USD/CNY: <strong id="rateValue">7.25</strong></span>
                </div>
                <div class="user-profile">
                    <div class="avatar" id="userAvatar">A</div>
                    <div id="userName">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                </div>
                <button class="logout-btn" onclick="handleLogout()">–í—ã—Ö–æ–¥</button>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="sidebar">
                <div class="sidebar-menu">
                    <div class="menu-item active" onclick="switchSection(event,'dashboard')">üìä –î–∞—à–±–æ—Ä–¥</div>
                    <div class="menu-item" onclick="switchSection(event,'upload')">üì§ –ó–∞–≥—Ä—É–∑–∫–∞</div>
                    <div class="menu-item" onclick="switchSection(event,'matrix')">üìä –ú–∞—Ç—Ä–∏—Ü–∞</div>
                    <div class="menu-item" onclick="switchSection(event,'analytics')">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
                    <div class="menu-item" onclick="switchSection(event,'companies')">üè¢ –ö–æ–º–ø–∞–Ω–∏–∏</div>
                </div>
            </div>

            <div class="content">
                <!-- DASHBOARD -->
                <section id="dashboard" class="section active">
                    <div class="stats-grid" id="statsGrid"></div>
                    <div class="card">
                        <div class="card-title">‚≠ê –¢–æ–ø 10 –ª—É—á—à–∏—Ö —Ü–µ–Ω</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                                    <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                                    <th>–¶–µ–Ω–∞ CNY</th>
                                    <th>–î–∞—Ç–∞</th>
                                </tr>
                            </thead>
                            <tbody id="topPricesList"></tbody>
                        </table>
                    </div>
                </section>

                <!-- UPLOAD -->
                <section id="upload" class="section">
                    <div class="card">
                        <div class="card-title">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel</div>
                        <div class="upload-zone" onclick="document.getElementById('excelFile').click()">
                            <p style="margin:0;font-weight:600;color:var(--primary);cursor:pointer">
                                üì§ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª
                            </p>
                            <p style="margin:5px 0 0;font-size:12px;color:var(--text-secondary)">
                                –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: XLSX, XLS, CSV
                            </p>
                            <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="handleExcelUpload(event)">
                        </div>
                        <div style="margin-top:20px;padding:15px;background:rgba(99,102,241,.05);border-radius:8px;font-size:12px">
                            <p><strong>‚ÑπÔ∏è –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:</strong></p>
                            <ul style="margin:10px 0 0 20px;color:var(--text-secondary)">
                                <li>–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏: –ø—Ä–æ–¥—É–∫—Ç, –∫–æ–º–ø–∞–Ω–∏–∏</li>
                                <li>–ü–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤</li>
                                <li>–û—Å—Ç–∞–ª—å–Ω—ã–µ —è—á–µ–π–∫–∏ ‚Äî —Ü–µ–Ω—ã –≤ CNY</li>
                                <li>–°–∏–º–≤–æ–ª ¬• –º–æ–∂–Ω–æ, –æ–Ω —É–¥–∞–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                            </ul>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">üè¢ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏</div>
                        <div class="upload-zone" onclick="document.getElementById('companiesFile').click()">
                            <p style="margin:0;font-weight:600;color:var(--primary);cursor:pointer">
                                üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª)
                            </p>
                            <input type="file" id="companiesFile" accept=".xlsx,.xls,.csv" onchange="handleCompaniesUpload(event)">
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">‚öôÔ∏è –î–µ–π—Å—Ç–≤–∏—è</div>
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
                    </div>
                </section>

                <!-- MATRIX -->
                <section id="matrix" class="section">
                    <div class="card">
                        <div class="card-title">üìä –ú–∞—Ç—Ä–∏—Ü–∞ —Ü–µ–Ω (CNY) —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π</div>
                        <div style="overflow-x:auto">
                            <table class="matrix-table" id="matrixTable">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="analytics-grid">
                        <div class="analysis-card">
                            <div class="analysis-title">üí∞ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</div>
                            <div class="analysis-value" id="avgPrice">-</div>
                            <div class="analysis-subtitle">–ø–æ –≤—Å–µ–º –ø—Ä–æ–¥—É–∫—Ç–∞–º</div>
                        </div>
                        <div class="analysis-card">
                            <div class="analysis-title">üìâ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è</div>
                            <div class="analysis-value" id="minPrice">-</div>
                            <div class="analysis-subtitle">—Å–∞–º–æ–µ –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</div>
                        </div>
                        <div class="analysis-card">
                            <div class="analysis-title">üìà –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è</div>
                            <div class="analysis-value" id="maxPrice">-</div>
                            <div class="analysis-subtitle">—Å–∞–º–æ–µ –¥–æ—Ä–æ–≥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</div>
                        </div>
                        <div class="analysis-card">
                            <div class="analysis-title">üéØ –°–∞–º–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è</div>
                            <div class="analysis-value" id="bestCompany">-</div>
                            <div class="analysis-subtitle">–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ª—É—á—à–∏—Ö —Ü–µ–Ω</div>
                        </div>
                    </div>
                </section>

                <!-- ANALYTICS -->
                <section id="analytics" class="section">
                    <div class="card">
                        <div class="card-title">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º</div>
                        <table id="companiesAnalytics">
                            <thead>
                                <tr>
                                    <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                                    <th>–ö–æ–ª-–≤–æ —Ü–µ–Ω</th>
                                    <th>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</th>
                                    <th>–ú–∏–Ω. —Ü–µ–Ω–∞</th>
                                    <th>–ú–∞–∫—Å. —Ü–µ–Ω–∞</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div class="card">
                        <div class="card-title">üèÜ –õ—É—á—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º</div>
                        <table id="productAnalytics">
                            <thead>
                                <tr>
                                    <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                                    <th>–õ—É—á—à–∞—è —Ü–µ–Ω–∞</th>
                                    <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                                    <th>–°—Ä–µ–¥–Ω–µ–µ</th>
                                    <th>–†–∞–∑–±—Ä–æ—Å</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <!-- COMPANIES -->
                <section id="companies" class="section">
                    <div class="card">
                        <div class="card-title">üè¢ –°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π</div>
                        <table id="companiesList">
                            <thead>
                                <tr>
                                    <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                                    <th>–ü—Ä–æ–¥—É–∫—Ç–æ–≤</th>
                                    <th>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </div>

<script>
const DB = { companies: [], prices: {} }; // prices: { product: { company: price } }
let currentUser = null;
let exchangeRate = 7.25;

// INIT
window.addEventListener('load', () => {
    safeLoadDB();
    const theme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', theme);

    if (currentUser) showMainApp();
    else showLoginApp();

    loadExchangeRate();
    setInterval(loadExchangeRate, 5*60*1000);
    console.log('‚úÖ App loaded');
});

// EXCHANGE RATE
function loadExchangeRate(){
    fetch('https://api.exchangerate-api.com/v4/latest/USD')
        .then(r=>r.json())
        .then(data=>{
            if(data && data.rates && data.rates.CNY){
                exchangeRate = data.rates.CNY;
                document.getElementById('rateValue').textContent = exchangeRate.toFixed(2);
            }
        })
        .catch(err=>{
            console.log('‚ö†Ô∏è –ö—É—Ä—Å –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω:', err);
        });
}

// STORAGE
function safeLoadDB(){
    try{
        const stored = localStorage.getItem('priceManagerDB');
        if(stored){
            const parsed = JSON.parse(stored);
            if(parsed && typeof parsed === 'object'){
                if(parsed.companies) DB.companies = parsed.companies;
                if(parsed.prices) DB.prices = parsed.prices;
            }
        }
    }catch(e){console.error(e);}

    try{
        const u = localStorage.getItem('currentUserPM');
        if(u) currentUser = JSON.parse(u);
    }catch(e){}

    if(!DB.companies || !Array.isArray(DB.companies) || DB.companies.length===0){
        DB.companies = [{id:1,name:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',site:''}];
    }
}

function safeSaveDB(){
    try{
        localStorage.setItem('priceManagerDB', JSON.stringify(DB));
        if(currentUser) localStorage.setItem('currentUserPM', JSON.stringify(currentUser));
    }catch(e){
        console.error(e);
        showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

// TOASTS
function showToast(msg,type='success'){
    const t=document.createElement('div');
    t.className='toast'+(type==='error'?' error':'');
    t.textContent=msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),3000);
}

// AUTH
function handleLogin(){
    const email=document.getElementById('loginEmail').value.trim();
    const pwd=document.getElementById('loginPassword').value;
    if(email==='admin@example.com' && pwd==='admin123'){
        currentUser={id:1,name:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',email};
        safeSaveDB();
        showMainApp();
    }else{
        showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ','error');
    }
}
function handleLogout(){
    if(confirm('–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')){
        currentUser=null;
        localStorage.removeItem('currentUserPM');
        location.reload();
    }
}
function showLoginApp(){
    document.getElementById('loginApp').classList.add('active');
    document.getElementById('mainApp').classList.remove('active');
}
function showMainApp(){
    document.getElementById('loginApp').classList.remove('active');
    document.getElementById('mainApp').classList.add('active');
    document.getElementById('userAvatar').textContent=currentUser.name[0].toUpperCase();
    document.getElementById('userName').textContent=currentUser.name;
    loadDashboard();
}

// NAV
function switchSection(ev,id){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active'));
    if(ev && ev.target) ev.target.closest('.menu-item').classList.add('active');

    const titles={
        dashboard:'üìä –î–∞—à–±–æ—Ä–¥',
        upload:'üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö',
        matrix:'üìä –ú–∞—Ç—Ä–∏—Ü–∞ —Ü–µ–Ω',
        analytics:'üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
        companies:'üè¢ –ö–æ–º–ø–∞–Ω–∏–∏'
    };
    document.getElementById('pageTitle').textContent=titles[id]||'–°—Ç—Ä–∞–Ω–∏—Ü–∞';

    if(id==='matrix') renderMatrix();
    if(id==='analytics') renderAnalytics();
    if(id==='companies') renderCompanies();
}

// EXCEL UPLOAD (MAIN)
function handleExcelUpload(e){
    const file=e.target.files[0];
    if(!file) return;

    const reader=new FileReader();
    reader.onload=(ev)=>{
        try{
            const data=new Uint8Array(ev.target.result);
            const wb=XLSX.read(data,{type:'array'});
            const sheet=wb.Sheets[wb.SheetNames[0]];
            const json=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});

            if(!json || json.length<2){
                showToast('‚ùå –ü—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–∞–π–ª','error');
                return;
            }

            // –û–∂–∏–¥–∞–µ–º: –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äì –∑–∞–≥–æ–ª–æ–≤–∫–∏ (Product, Company1, Company2,...)
            const headers=json[0].map(h=>String(h).trim()).filter(h=>h!=='');
            if(headers.length<2){
                showToast('‚ùå –í –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–æ–¥—É–∫—Ç –∏ –∫–æ–º–ø–∞–Ω–∏–∏','error');
                return;
            }

            const productColIndex=0; // –ø–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –ø—Ä–æ–¥—É–∫—Ç
            const companyNames=headers.slice(1); // –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äì –∫–æ–º–ø–∞–Ω–∏–∏

            // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π
            DB.companies = companyNames.map((name,i)=>({
                id:i+1,
                name,
                site:''
            }));

            // –û—á–∏—â–∞–µ–º —Ü–µ–Ω—ã
            DB.prices={};

            // –°—Ç—Ä–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
            for(let r=1;r<json.length;r++){
                const row=json[r];
                if(!row || row.length===0) continue;

                const product=String(row[productColIndex]||'').trim();
                if(!product) continue;

                if(!DB.prices[product]) DB.prices[product]={};

                for(let c=1;c<headers.length;c++){
                    const company=headers[c];
                    let val=row[c];

                    if(val===null || val===undefined || val==='') continue;

                    // –ß–∏—Å—Ç–∏–º —Å—Ç—Ä–æ–∫—É —Ü–µ–Ω—ã: —É–±–∏—Ä–∞–µ–º ¬•, –ø—Ä–æ–±–µ–ª—ã, –∑–∞–ø—è—Ç—ã–µ
                    let str=String(val).replace(/¬•/g,'').replace(/\s/g,'').replace(/,/g,'.');
                    const num=parseFloat(str);
                    if(!isNaN(num)){
                        DB.prices[product][company]=num;
                    }
                }
            }

            safeSaveDB();
            showToast(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: ${Object.keys(DB.prices).length}, –∫–æ–º–ø–∞–Ω–∏–π: ${DB.companies.length}`);
            loadDashboard();
            e.target.value='';
            console.log('üì• –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', DB);
        }catch(err){
            console.error('‚ùå Excel parse error',err);
            showToast('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ (—Å–º. –∫–æ–Ω—Å–æ–ª—å)','error');
        }
    };
    reader.readAsArrayBuffer(file);
}

// COMPANIES UPLOAD (OPTIONAL)
function handleCompaniesUpload(e){
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=(ev)=>{
        try{
            const data=new Uint8Array(ev.target.result);
            const wb=XLSX.read(data,{type:'array'});
            const sheet=wb.Sheets[wb.SheetNames[0]];
            const json=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});

            DB.companies=[];
            for(let i=1;i<json.length;i++){
                const row=json[i];
                if(!row || !row[0]) continue;
                DB.companies.push({
                    id:i,
                    name:String(row[0]).trim(),
                    site:String(row[1]||'').trim()
                });
            }
            safeSaveDB();
            showToast(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–æ–º–ø–∞–Ω–∏–π: ${DB.companies.length}`);
            e.target.value='';
        }catch(err){
            console.error(err);
            showToast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π','error');
        }
    };
    reader.readAsArrayBuffer(file);
}

// CLEAR DATA
function clearAllData(){
    if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ü–µ–Ω –∏ –∫–æ–º–ø–∞–Ω–∏–π?')){
        DB.prices={};
        DB.companies=[{id:1,name:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',site:''}];
        safeSaveDB();
        loadDashboard();
        showToast('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
    }
}

// DASHBOARD
function loadDashboard(){
    const productCount=Object.keys(DB.prices).length;
    const totalPrices=Object.values(DB.prices)
        .reduce((sum,p)=>sum+Object.keys(p).length,0);

    document.getElementById('statsGrid').innerHTML=`
        <div class="stat-card">
            <div class="stat-label">–ö–æ–º–ø–∞–Ω–∏–π</div>
            <div class="stat-value">${DB.companies.length}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">–ü—Ä–æ–¥—É–∫—Ç–æ–≤</div>
            <div class="stat-value">${productCount}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">–ó–∞–ø–∏—Å–µ–π —Ü–µ–Ω</div>
            <div class="stat-value">${totalPrices}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">–ö—É—Ä—Å USD/CNY</div>
            <div class="stat-value">${exchangeRate.toFixed(2)}</div>
        </div>
    `;

    const allPrices=[];
    for(const [product,companies] of Object.entries(DB.prices)){
        for(const [company,price] of Object.entries(companies)){
            allPrices.push({product,company,price});
        }
    }
    const top=allPrices.sort((a,b)=>a.price-b.price).slice(0,10);
    const tbody=document.getElementById('topPricesList');
    if(top.length===0){
        tbody.innerHTML='<tr><td colspan="4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel.</td></tr>';
    }else{
        tbody.innerHTML=top.map(p=>`
            <tr>
                <td><strong>${p.product}</strong></td>
                <td>${p.company}</td>
                <td><span class="badge badge-success">¬•${p.price.toFixed(2)}</span></td>
                <td>${new Date().toLocaleDateString('ru-RU')}</td>
            </tr>
        `).join('');
    }
}

// MATRIX + SUMMARY
function renderMatrix(){
    const table=document.getElementById('matrixTable');
    const thead=table.querySelector('thead');
    const tbody=table.querySelector('tbody');

    const products=Object.keys(DB.prices);
    if(products.length===0){
        thead.innerHTML='';
        tbody.innerHTML='<tr><td>üì§ –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ó–∞–≥—Ä—É–∑–∫–∞"</td></tr>';
        document.getElementById('avgPrice').textContent='-';
        document.getElementById('minPrice').textContent='-';
        document.getElementById('maxPrice').textContent='-';
        document.getElementById('bestCompany').textContent='-';
        return;
    }

    const companies=[...new Set(products.flatMap(p=>Object.keys(DB.prices[p])))];

    // HEAD
    let headRow='<tr><th>–ü—Ä–æ–¥—É–∫—Ç</th>';
    companies.forEach(c=>headRow+=`<th>${c}</th>`);
    headRow+='</tr>';
    thead.innerHTML=headRow;

    // BODY
    let rowsHTML='';
    const allNumericPrices=[];
    const bestCountByCompany={};

    products.forEach(product=>{
        const rowPrices=DB.prices[product];
        const rowValues=companies.map(c=>rowPrices[c]).filter(v=>typeof v==='number');
        const minRow=Math.min(...rowValues);

        rowsHTML+=`<tr><td style="text-align:left">${product}</td>`;
        companies.forEach(company=>{
            const price=rowPrices[company];
            if(typeof price!=='number'){
                rowsHTML+='<td>-</td>';
            }else{
                allNumericPrices.push(price);
                let cls='average';
                if(price===minRow){
                    cls='best';
                    bestCountByCompany[company]=(bestCountByCompany[company]||0)+1;
                }else if(price>minRow*1.2){
                    cls='high';
                }
                rowsHTML+=`<td><div class="price-cell ${cls}">¬•${price.toFixed(2)}</div></td>`;
            }
        });
        rowsHTML+='</tr>';
    });

    tbody.innerHTML=rowsHTML;

    if(allNumericPrices.length>0){
        const sum=allNumericPrices.reduce((a,b)=>a+b,0);
        const avg=sum/allNumericPrices.length;
        const min=Math.min(...allNumericPrices);
        const max=Math.max(...allNumericPrices);
        document.getElementById('avgPrice').textContent='¬•'+avg.toFixed(2);
        document.getElementById('minPrice').textContent='¬•'+min.toFixed(2);
        document.getElementById('maxPrice').textContent='¬•'+max.toFixed(2);

        let bestCompany='-';
        let bestCount=0;
        for(const [c,count] of Object.entries(bestCountByCompany)){
            if(count>bestCount){bestCount=count;bestCompany=c;}
        }
        document.getElementById('bestCompany').textContent=bestCompany==='-'?'-':`${bestCompany} (${bestCount})`;
    }else{
        document.getElementById('avgPrice').textContent='-';
        document.getElementById('minPrice').textContent='-';
        document.getElementById('maxPrice').textContent='-';
        document.getElementById('bestCompany').textContent='-';
    }
}

// ANALYTICS (COMPANIES + PRODUCTS)
function renderAnalytics(){
    const companiesAnalyticsBody=document.querySelector('#companiesAnalytics tbody');
    const productAnalyticsBody=document.querySelector('#productAnalytics tbody');

    const companyStats={}; // name -> {count,sum,min,max}

    for(const [product,companies] of Object.entries(DB.prices)){
        for(const [company,price] of Object.entries(companies)){
            if(typeof price!=='number') continue;
            if(!companyStats[company]) companyStats[company]={count:0,sum:0,min:price,max:price};
            const s=companyStats[company];
            s.count++; s.sum+=price;
            if(price<s.min) s.min=price;
            if(price>s.max) s.max=price;
        }
    }

    const companiesRows=Object.entries(companyStats).map(([name,s])=>{
        const avg=s.sum/s.count;
        const status=avg===s.min?'–õ–∏–¥–µ—Ä':'–ù–æ—Ä–º–∞–ª—å–Ω—ã–π';
        const badgeClass=avg===s.min?'badge-success':'badge-warning';
        return `
            <tr>
                <td>${name}</td>
                <td>${s.count}</td>
                <td>¬•${avg.toFixed(2)}</td>
                <td>¬•${s.min.toFixed(2)}</td>
                <td>¬•${s.max.toFixed(2)}</td>
                <td><span class="badge ${badgeClass}">${status}</span></td>
            </tr>
        `;
    }).join('');
    companiesAnalyticsBody.innerHTML=companiesRows || '<tr><td colspan="6">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';

    // PRODUCTS ANALYTICS
    const productRows=Object.entries(DB.prices).map(([product,companies])=>{
        const prices=Object.values(companies).filter(v=>typeof v==='number');
        if(prices.length===0) return '';
        const minPrice=Math.min(...prices);
        const maxPrice=Math.max(...prices);
        const sum=prices.reduce((a,b)=>a+b,0);
        const avg=sum/prices.length;
        const bestCompany=Object.entries(companies).find(([c,p])=>p===minPrice)?.[0]||'-';
        const spread=maxPrice-minPrice;

        return `
            <tr>
                <td>${product}</td>
                <td>¬•${minPrice.toFixed(2)}</td>
                <td>${bestCompany}</td>
                <td>¬•${avg.toFixed(2)}</td>
                <td>¬•${spread.toFixed(2)}</td>
            </tr>
        `;
    }).filter(Boolean).join('');
    productAnalyticsBody.innerHTML=productRows || '<tr><td colspan="5">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
}

// COMPANIES LIST
function renderCompanies(){
    const tbody=document.querySelector('#companiesList tbody');

    const statsByCompany={};
    for(const [product,companies] of Object.entries(DB.prices)){
        for(const [company,price] of Object.entries(companies)){
            if(typeof price!=='number') continue;
            if(!statsByCompany[company]) statsByCompany[company]={products:new Set(),sum:0,count:0};
            statsByCompany[company].products.add(product);
            statsByCompany[company].sum+=price;
            statsByCompany[company].count++;
        }
    }

    const rows=Object.entries(statsByCompany).map(([name,s])=>{
        const avg=s.sum/s.count;
        return `
            <tr>
                <td>${name}</td>
                <td>${s.products.size}</td>
                <td>¬•${avg.toFixed(2)}</td>
            </tr>
        `;
    }).join('');

    tbody.innerHTML=rows || '<tr><td colspan="3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
}
</script>
</body>
</html>
