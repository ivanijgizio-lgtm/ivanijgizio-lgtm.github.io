<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Manager Pro Elite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-darker: #020617;
            --surface-dark: #1e293b;
            --surface-darker: #0f172a;
            --border-dark: #334155;
            --text-light: #f1f5f9;
            --text-gray: #cbd5e1;
            --text-dark: #94a3b8;
            --bg-light: #f8fafc;
            --surface-light: #ffffff;
            --border-light: #e2e8f0;
            --text-dark-mode: #1e293b;
            --text-gray-light: #475569;
        }

        html {
            --bg: var(--bg-dark);
            --surface: var(--surface-dark);
            --border: var(--border-dark);
            --text: var(--text-light);
            --text-secondary: var(--text-gray);
        }

        html[data-theme="light"] {
            --bg: var(--bg-light);
            --surface: var(--surface-light);
            --border: var(--border-light);
            --text: var(--text-dark-mode);
            --text-secondary: var(--text-gray-light);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s, color 0.3s;
            overflow: hidden;
        }

        .app {
            display: none;
        }

        .app.active {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-menu {
            flex: 1;
            padding: 20px 0;
        }

        .menu-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 3px solid transparent;
            font-size: 14px;
            font-weight: 500;
        }

        .menu-item:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-light);
            border-left-color: var(--primary);
        }

        .menu-item.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .theme-toggle {
            width: 100%;
            padding: 10px 15px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--primary);
            border-radius: 8px;
            color: var(--primary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 22px;
            font-weight: 700;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .logout-btn {
            padding: 8px 16px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-full {
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(99, 102, 241, 0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-primary {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--surface);
            border-left: 4px solid var(--success);
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            animation: slideIn 0.3s ease-in-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .login-page {
            display: none;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
        }

        .login-page.active {
            display: flex;
        }

        .login-box {
            background: var(--surface);
            padding: 40px;
            border-radius: 16px;
            width: 100%;
            max-width: 420px;
        }

        .login-box h1 {
            margin: 0 0 30px 0;
            font-size: 28px;
            text-align: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .error-msg {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            border-left: 4px solid var(--danger);
        }

        .toggle-link {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
        }

        .toggle-link a {
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div id="loginApp" class="login-page active">
        <div class="login-box">
            <div id="loginForm">
                <h1>üíé Price Manager Pro</h1>
                <div class="error-msg" id="loginError"></div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="admin@example.com" value="admin@example.com">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="admin123">
                </div>
                <button class="btn btn-primary btn-full" onclick="handleLogin()" style="margin-top: 10px;">
                    –í—Ö–æ–¥
                </button>
                <div class="toggle-link">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="toggleLoginRegister()">–°–æ–∑–¥–∞—Ç—å</a>
                </div>
            </div>

            <div id="registerForm" style="display: none;">
                <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
                <div class="error-msg" id="registerError"></div>
                <div class="form-group">
                    <label>–§–ò</label>
                    <input type="text" id="regName" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="regEmail" placeholder="ivan@example.com">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="regPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn btn-primary btn-full" onclick="handleRegister()" style="margin-top: 10px;">
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
                <div class="toggle-link">
                    –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="toggleLoginRegister()">–í–æ–π—Ç–∏</a>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="app">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">‚öôÔ∏è PMP Elite</div>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" onclick="switchSection('dashboard')">
                    üìä –î–∞—à–±–æ—Ä–¥
                </div>
                <div class="menu-item" onclick="switchSection('prices')">
                    üí∞ –¶–µ–Ω—ã
                </div>
                <div class="menu-item" onclick="switchSection('comparison')">
                    üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
                </div>
                <div class="menu-item" onclick="switchSection('companies')">
                    üè¢ –ö–æ–º–ø–∞–Ω–∏–∏
                </div>
            </div>
            <div class="sidebar-footer">
                <button class="theme-toggle" onclick="toggleTheme()">üåô –¢–µ–º–∞</button>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h2 class="page-title" id="pageTitle">üìä –î–∞—à–±–æ—Ä–¥</h2>
                <div class="header-right">
                    <div class="user-profile">
                        <div class="avatar" id="userAvatar">A</div>
                        <div>
                            <div style="font-weight: 600;" id="userName">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                        </div>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">–í—ã—Ö–æ–¥</button>
                </div>
            </div>

            <div class="content">
                <section id="dashboard" class="section active">
                    <div class="stats-grid" id="statsGrid"></div>
                    <div class="card">
                        <div class="card-title">‚≠ê –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã</div>
                        <table id="pricesTableDash">
                            <thead><tr><th>–ö–æ–º–ø–∞–Ω–∏—è</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–¶–µ–Ω–∞ CNY</th><th>–î–∞—Ç–∞</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <section id="prices" class="section">
                    <div class="card">
                        <div class="card-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—É</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>–ö–æ–º–ø–∞–Ω–∏—è</label>
                                <select id="priceCompanySelect"><option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option></select>
                            </div>
                            <div class="form-group">
                                <label>–ü—Ä–æ–¥—É–∫—Ç</label>
                                <input type="text" id="priceProduct" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                            </div>
                            <div class="form-group">
                                <label>–¶–µ–Ω–∞ USD</label>
                                <input type="number" id="priceValue" placeholder="0.00" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>–û–±—ä—ë–º</label>
                                <input type="number" id="priceVolume" placeholder="0" step="1">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addPrice()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>

                    <div class="card">
                        <div class="card-title">üìã –¢–∞–±–ª–∏—Ü–∞ —Ü–µ–Ω</div>
                        <input type="text" id="priceSearch" placeholder="üîç –ü–æ–∏—Å–∫..." onkeyup="filterPrices()" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); margin-bottom: 15px;">
                        <table id="pricesTable">
                            <thead><tr><th>–ö–æ–º–ø–∞–Ω–∏—è</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–¶–µ–Ω–∞ CNY</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <section id="comparison" class="section">
                    <div class="card">
                        <div class="card-title">üìä –ú–∞—Ç—Ä–∏—Ü–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω</div>
                        <div id="comparisonTable"></div>
                    </div>
                </section>

                <section id="companies" class="section">
                    <div class="card">
                        <div class="card-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                <input type="text" id="companyName" placeholder="–û–û–û –ö–æ–º–ø–∞–Ω–∏—è">
                            </div>
                            <div class="form-group">
                                <label>–°–∞–π—Ç</label>
                                <input type="url" id="companySite" placeholder="https://example.com">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addCompany()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>

                    <div class="card">
                        <div class="card-title">üè¢ –°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π</div>
                        <table id="companiesTable">
                            <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°–∞–π—Ç</th><th>–¶–µ–Ω</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ App starting...');
        const DB = { users: [], companies: [], prices: [] };
        let currentUser = null;
        let exchangeRate = 7.25;

        function safeLoadDB() {
            try {
                const stored = localStorage.getItem('priceManagerDB');
                if (stored) {
                    Object.assign(DB, JSON.parse(stored));
                    console.log('‚úÖ DB loaded');
                }
            } catch (err) {
                console.error('‚ùå Load error:', err);
            }
            
            try {
                const user = localStorage.getItem('currentUserPM');
                if (user) currentUser = JSON.parse(user);
            } catch (err) {
                console.error('‚ùå User load error:', err);
            }

            if (!DB.users.length) {
                DB.users = [{
                    id: 1, name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', email: 'admin@example.com', password: 'admin123'
                }];
                safeSaveDB();
            }
        }

        function safeSaveDB() {
            try {
                localStorage.setItem('priceManagerDB', JSON.stringify(DB));
                if (currentUser) localStorage.setItem('currentUserPM', JSON.stringify(currentUser));
                console.log('‚úÖ DB saved');
            } catch (err) {
                console.error('‚ùå Save error:', err);
            }
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleLoginRegister() {
            document.getElementById('loginForm').style.display = 
                document.getElementById('loginForm').style.display === 'none' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = 
                document.getElementById('registerForm').style.display === 'none' ? 'block' : 'none';
        }

        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            const user = DB.users.find(u => u.email === email && u.password === password);
            if (!user) {
                document.getElementById('loginError').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                document.getElementById('loginError').style.display = 'block';
                return;
            }

            currentUser = user;
            safeSaveDB();
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('loginApp').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');
            document.getElementById('userAvatar').textContent = user.name[0].toUpperCase();
            document.getElementById('userName').textContent = user.name;
            loadDashboard();
        }

        function handleRegister() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;

            if (!name || !email || !password) {
                document.getElementById('registerError').textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                document.getElementById('registerError').style.display = 'block';
                return;
            }

            if (DB.users.find(u => u.email === email)) {
                document.getElementById('registerError').textContent = 'Email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
                document.getElementById('registerError').style.display = 'block';
                return;
            }

            const newUser = { id: DB.users.length + 1, name, email, password };
            DB.users.push(newUser);
            safeSaveDB();
            currentUser = newUser;
            document.getElementById('loginApp').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');
            loadDashboard();
        }

        function handleLogout() {
            if (confirm('–í—ã—Ö–æ–¥?')) {
                currentUser = null;
                localStorage.removeItem('currentUserPM');
                location.reload();
            }
        }

        function switchSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event.target.closest('.menu-item').classList.add('active');

            const titles = {
                dashboard: 'üìä –î–∞—à–±–æ—Ä–¥',
                prices: 'üí∞ –¶–µ–Ω—ã',
                comparison: 'üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ',
                companies: 'üè¢ –ö–æ–º–ø–∞–Ω–∏–∏'
            };
            document.getElementById('pageTitle').textContent = titles[id];
        }

        function toggleTheme() {
            const html = document.documentElement;
            const theme = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        function loadDashboard() {
            const stats = [
                { label: '–ö–æ–º–ø–∞–Ω–∏–π', value: DB.companies.length },
                { label: '–ü—Ä–æ–¥—É–∫—Ç–æ–≤', value: new Set(DB.prices.map(p => p.product)).size },
                { label: '–¶–µ–Ω', value: DB.prices.length }
            ];

            document.getElementById('statsGrid').innerHTML = stats.map(s => `
                <div class="stat-card">
                    <div class="stat-label">${s.label}</div>
                    <div class="stat-value">${s.value}</div>
                </div>
            `).join('');

            const tbody = document.querySelector('#pricesTableDash tbody');
            tbody.innerHTML = DB.prices.slice(-5).map(p => {
                const c = DB.companies.find(x => x.id === p.companyId);
                return `<tr><td>${c?.name || '‚Äî'}</td><td>${p.product}</td><td>¬•${(p.value * exchangeRate).toFixed(2)}</td><td>${p.date}</td></tr>`;
            }).join('');

            loadCompanies();
            loadPrices();
        }

        function addPrice() {
            const companyId = parseInt(document.getElementById('priceCompanySelect').value);
            const product = document.getElementById('priceProduct').value.trim();
            const value = parseFloat(document.getElementById('priceValue').value);

            if (!companyId || !product || !value) {
                showToast('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            DB.prices.push({
                id: DB.prices.length + 1, companyId, product, value,
                date: new Date().toLocaleDateString('ru-RU')
            });
            safeSaveDB();
            showToast('‚úÖ –¶–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
            document.getElementById('priceProduct').value = '';
            document.getElementById('priceValue').value = '';
            loadPrices();
            loadDashboard();
        }

        function loadPrices() {
            const tbody = document.querySelector('#pricesTable tbody');
            tbody.innerHTML = DB.prices.map(p => {
                const c = DB.companies.find(x => x.id === p.companyId);
                return `<tr>
                    <td>${c?.name || '‚Äî'}</td>
                    <td>${p.product}</td>
                    <td><span class="badge badge-primary">¬•${(p.value * exchangeRate).toFixed(2)}</span></td>
                    <td>${p.date}</td>
                    <td><button class="btn btn-danger" onclick="deletePrice(${p.id})">üóëÔ∏è</button></td>
                </tr>`;
            }).join('') || '<tr><td colspan="5">–ù–µ—Ç —Ü–µ–Ω</td></tr>';

            document.getElementById('priceCompanySelect').innerHTML = 
                '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>' + 
                DB.companies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            loadComparison();
        }

        function filterPrices() {
            const q = document.getElementById('priceSearch').value.toLowerCase();
            document.querySelectorAll('#pricesTable tbody tr').forEach(tr => {
                tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
            });
        }

        function deletePrice(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                DB.prices = DB.prices.filter(p => p.id !== id);
                safeSaveDB();
                loadPrices();
            }
        }

        function loadComparison() {
            const products = [...new Set(DB.prices.map(p => p.product))];
            const companies = [...new Set(DB.prices.map(p => DB.companies.find(c => c.id === p.companyId)?.name))].filter(Boolean);

            let html = '<table><tr style="background: rgba(99, 102, 241, 0.1);"><th>–ü—Ä–æ–¥—É–∫—Ç</th>';
            companies.forEach(c => html += `<th>${c}</th>`);
            html += '</tr>';

            products.forEach(prod => {
                html += `<tr><td style="font-weight: 600;">${prod}</td>`;
                companies.forEach(comp => {
                    const price = DB.prices.find(p => p.product === prod && DB.companies.find(c => c.id === p.companyId)?.name === comp);
                    html += `<td>${price ? '¬•' + (price.value * exchangeRate).toFixed(2) : '‚Äî'}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            document.getElementById('comparisonTable').innerHTML = html;
        }

        function addCompany() {
            const name = document.getElementById('companyName').value.trim();
            const site = document.getElementById('companySite').value.trim();

            if (!name) {
                showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
                return;
            }

            DB.companies.push({ id: DB.companies.length + 1, name, site });
            safeSaveDB();
            showToast('‚úÖ –ö–æ–º–ø–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞');
            document.getElementById('companyName').value = '';
            document.getElementById('companySite').value = '';
            loadCompanies();
            loadPrices();
        }

        function loadCompanies() {
            const tbody = document.querySelector('#companiesTable tbody');
            tbody.innerHTML = DB.companies.map(c => {
                const count = DB.prices.filter(p => p.companyId === c.id).length;
                return `<tr>
                    <td><strong>${c.name}</strong></td>
                    <td><a href="${c.site}" target="_blank" style="color: var(--primary);">${c.site || '‚Äî'}</a></td>
                    <td>${count}</td>
                    <td><button class="btn btn-danger" onclick="deleteCompany(${c.id})">üóëÔ∏è</button></td>
                </tr>`;
            }).join('') || '<tr><td colspan="4">–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π</td></tr>';
        }

        function deleteCompany(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                DB.companies = DB.companies.filter(c => c.id !== id);
                DB.prices = DB.prices.filter(p => p.companyId !== id);
                safeSaveDB();
                loadCompanies();
                loadPrices();
            }
        }

        window.addEventListener('load', () => {
            console.log('‚úÖ Page loaded');
            safeLoadDB();
            const theme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);

            if (currentUser) {
                document.getElementById('loginApp').classList.remove('active');
                document.getElementById('mainApp').classList.add('active');
                document.getElementById('userAvatar').textContent = currentUser.name[0].toUpperCase();
                document.getElementById('userName').textContent = currentUser.name;
                loadDashboard();
            } else {
                document.getElementById('loginApp').classList.add('active');
            }
        });
    </script>
</body>
</html>
